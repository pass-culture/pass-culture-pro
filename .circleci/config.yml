version: 2.0

jobs:
  build:
    machine:
      image: ubuntu-1604:201903-01
    working_directory: ~/
    steps:
      - run:
          name: Initialization environment
          command: |
            git clone --single-branch --branch $CIRCLE_BRANCH https://github.com/betagouv/pass-culture-main.git pass-culture-main || git clone https://github.com/betagouv/pass-culture-main.git pass-culture-main
            cd pass-culture-main
            git clone --single-branch --branch $CIRCLE_BRANCH https://github.com/betagouv/pass-culture-api.git api || git clone https://github.com/betagouv/pass-culture-api.git api
            ./install_lib_ci.sh
      - checkout:
          path: ~/pass-culture-main/pro

  deploy-pro:
    machine:
      image: ubuntu-1604:201903-01
    working_directory: ~/
    steps:
      - run:
          name: Checkout main
          command: |
            git clone --single-branch --branch $CIRCLE_BRANCH https://github.com/betagouv/pass-culture-main.git pass-culture-main || git clone https://github.com/betagouv/pass-culture-main.git pass-culture-main
      - checkout:
          path: ~/pass-culture-main/pro
      - run:
          name: Install Lib CI
          command: |
            cd ~/pass-culture-main/pro
            ./scripts/install_lib_ci_pro.sh
      - run:
          name: Build and Deploy
          command: |
            cd ~/pass-culture-main/pro
            export NVM_DIR="/opt/circleci/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
            nvm install
            yarn install

            set -a; source ~/pass-culture-main/config/run_envs/staging

            yarn build
            npm install -g netlify-cli@2.46.0
            netlify deploy -s "${NETLIFY_SITE_ID_PRO}" -a "${NETLIFY_TOKEN}" -d build/ --prod

workflows:
  version: 2
  commit:
    jobs:
      - build
      - deploy-pro:
          filters:
            branches:
              only:
                - pc-4290-filter-sold-out-offers
          requires:
            - build
